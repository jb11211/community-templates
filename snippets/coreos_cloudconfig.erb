#cloud-config
<%#
kind: snippet
name: coreos_cloudconfig
%>
      coreos:
        etcd:
<% if @host.params['etcd_discovery_url'] -%>
          discovery: <%= @host.params['etcd_discovery_url'] %>
<% end -%>
          addr: <%= @host.ip %>:4001
          peer-addr: <%= @host.ip %>:7001
        units:
          - name: etcd.service
            command: start
          - name: fleet.service
            command: start
          - name: docker-tcp.socket
            command: start
            enable: yes
            content: |
              [Unit]
              Description=Docker Socket for the API
              
              [Socket]
              ListenStream=2375
              BindIPv6Only=both
              Service=docker.service
              
              [Install]
              WantedBy=sockets.target
          - name: enable-docker-tcp.service
            command: start
            content: |
              [Unit]
              Description=Enable the Docker Socket for the API
              
              [Service]
              Type=oneshot
              ExecStart=/usr/bin/systemctl enable docker-tcp.socket
<% if @host.params['ssh_authorized_keys'] -%>
      ssh_authorized_keys:
  <% @host.params['ssh_authorized_keys'].split(',').map(&:strip).each do |ssh_key| -%>
      - "<%= ssh_key %>"
  <% end -%>
<% end -%>
      write_files:
<% if (proxy = @host.params["http_proxy"]) then no_proxy = "" -%>
      - path: /etc/wgetrc
        owner: root:root
        permissions: 0644
        content: |
          http_proxy = <%= proxy %>
          no_proxy = localhost,127.0.0.0/8,*.local,*.<%= @host.domain.name -%>,puppet
      - path: /etc/profile.d/proxy.sh
        owner: root:root
        permissions: 0755
        content: |
          export http_proxy="<%= proxy %>"
          export HTTP_PROXY="<%= proxy %>"
          export no_proxy="localhost,127.0.0.0/8,*.local,*.<%= @host.domain.name -%>,puppet"
      - path: /etc/systemd/system/docker.service.d/http-proxy.conf
        owner: core:core
        permissions: 0644
        content: |
          [Service]
          Environment="HTTP_PROXY=<%= proxy %>"
<% end -%>
